# 音卓（ON Taku）割引機能 要件定義 / 仕様書

対象: イベント料金シミュレーターおよび割引適用機能  
出典: Shopify / Stripe / MoneyForward / SAP Commerce 等の一般的割引仕様

---

## 🧩 機能概要

- イベント料金に対し複数の割引（％・円額・特典/送料）を組み合わせてシミュレーション・適用する。  
- 割引は有効期間・条件・優先度・併用ルールで制御し、計算順序・丸め方法・税計算を共通ポリシーとして定義。  
- 割引後料金を即時可視化し、ユーザーが最適な割引を選択できるよう支援。  
- 適用時はスナップショット保存で再計算時の再現性を保証。

## ⚙️ 機能

### 1. 割引マスタ管理
| 項目 | 内容 |
| --- | --- |
| 割引方法 | 円引き / ％引き / 特典 / 送料調整 |
| 種別 | セット割 / 学割 / スタッフ割 / 早割など（マスタで拡張） |
| 対象範囲 | イベント料全体 / チケット料金 / ドリンク料金 / 物販 |
| 条件 | 最低金額・数量・ロール・会場・時間帯・クーポンコード・回数上限 等 |
| 有効期間 | 適用開始日/終了日（JST / 会場タイムゾーン） |
| 併用ルール | 併用可 / 同一範囲排他 / 完全排他 |
| 上限 | 割引キャップ金額・利用回数制限（ユーザー単位 / イベント単位） |

### 2. 料金シミュレーター
- 複数割引をチェックボックスで選択し即時計算プレビュー。  
- 通常料金・割引後料金・内訳・計算順序・税額を明示。  
- 期限状態（利用可能 / 開始前 / 期限切れ）をバッジ表示。  
- 条件不一致時は「適用不可」理由をツールチップ表示。

### 3. 適用・確定処理
- 確定時に割引スナップショット（割引ID・版・順序・丸め方式・税モード・結果金額・根拠ログ）を保存。  
- 割引金額は対象範囲ごとに按分し、税率別に再集計。

### 4. 監査・再現性
- 過去取引を当時設定で完全再計算可能。  
- 外部システムとの税額差異が出た際はスナップショット値を優先使用。

## 🧾 確定仕様

### 割引計算順序
| 設定 | 内容 |
| --- | --- |
| 既定順序 | ％ → 円額 |
| UI表示 | 割引一覧に適用順序を常時表示 |
| 対策理由 | 順序違いによる金額差・誤解を防ぐ |

### 税計算
- 値引き後課税（小計→割引→税→合計）。  
- 割引を税率別に按分し軽減税率にも対応。  
- 外部決済連携時は税を再計算せず受領値を固定。

### 丸めルール
| 項目 | 内容 |
| --- | --- |
| 通貨精度 | 円単位（int） |
| 処理方式 | 各ステップで四捨五入 → 最終合計で再丸め |
| 設定切替 | `round` / `floor` / `ceil` を設定ファイルで切替可 |
| 現金取引 | POS用端数丸めを将来導入予定 |

### 併用・排他ルール
- 併用可 / 同一範囲排他 / 完全排他の3種。  
- 同一範囲で競合時は優先度または割引額が大きい方を自動適用。  
- 画面上で「併用不可」「競合あり」を明示。

### 条件・期間・表示
| 状態 | 表示 |
| --- | --- |
| 利用可能 | 利用可能 |
| 開始前 | 開始前 |
| 期限切れ | 期限切れ |
| 公開前 | 未公開 |

- 条件未達（最低金額・数量・会場・コードなど）は自動で非選択化し理由を表示。  
- 割引名の横に上限・回数・説明文を表示。

## 🎯 割引適用順序

| 適用順 | 割引種別 | 目的 | 範囲 | 備考 |
| --- | --- | --- | --- | --- |
| ① | セット割 | ベース価格確定 | チケット＋物販等 | 組み合わせ販売の基準 |
| ② | 学割 | 資格割引 | チケット | 恒久割引 |
| ③ | スタッフ割 | 内部特典 | チケット＋物販 | 学割と排他 |
| ④ | 早割 | 期間限定販促 | チケット | 最後に適用 |

- 方法ミックス時も％→円で統一。

## 🧮 計算例
- チケット3,000円 + ドリンク500円。  
- セット割500円、学割10%、早割5%。  
- 既定順序((3,000 - 500) × 0.9 × 0.95) + 500 = 2,637円。

## 🧠 運用ポリシー
1. 順序ポリシー固定（セット→学割→スタッフ→早割 / ％先行）。  
2. 適用範囲をマスタで明示し重複時は優先度で決定。  
3. 丸めポリシーはステップごとに四捨五入＋最終丸め。  
4. 資格割引（学割/スタッフ割）は排他。  
5. 早割は他割引と併用可。  
6. 税計算は割引後課税。  
7. スナップショット保存が必須。

## 📊 拡張予定
| 項目 | 内容 | 状態 |
| --- | --- | --- |
| 割引カテゴリのマスタ化 | 種別ごとに順序・適用範囲・併用ルールを保持 | 対応予定 |
| 割引タグ | 恒常/期間限定/内部向けなどをUI表示 | 設計中 |
| シミュレーション履歴 | 条件と計算過程をJSON保存 | 実装予定 |
| 優先度編集UI | 管理画面でドラッグ&ドロップ並び替え | 検討中 |

