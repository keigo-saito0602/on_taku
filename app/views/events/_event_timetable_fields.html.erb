<% timetable = f.object %>
<% stage_classes = ["rounded-2xl border border-slate-200 bg-white p-5 shadow-sm"] %>
<% stage_classes << "stage-hidden" if timetable.marked_for_destruction? %>
<div class="<%= stage_classes.join(" ") %>" data-timetable-stages-target="stage">
  <div class="flex flex-col gap-4" data-controller="timetable-editor"
       data-timetable-editor-templates-value="<%= TimetableSlot::PERFORMANCE_TEMPLATES.to_json %>"
       data-timetable-editor-changeover-templates-value="<%= TimetableSlot::CHANGEOVER_TEMPLATES.to_json %>">
    <%= f.hidden_field :id %>
    <%= f.hidden_field :position, value: timetable.position, data: { role: "stage-position" } %>
    <%= f.hidden_field :_destroy, value: false, data: { timetable_editor_target: "stageDestroy" } %>

    <div class="flex flex-wrap items-center justify-between gap-3 border-b border-slate-100 pb-4">
      <div class="flex flex-col gap-1">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">ステージ名</label>
        <%= f.text_field :stage_name, class: "w-60 rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200" %>
      </div>
      <% if allow_remove_stage %>
        <button type="button"
                class="inline-flex items-center rounded-lg border border-rose-200 bg-white px-3 py-2 text-xs font-semibold text-rose-600 transition hover:bg-rose-50"
                data-action="click->timetable-editor#removeStage click->timetable-stages#refresh"
                data-role="remove-stage">
          このタイムテーブルを削除
        </button>
      <% end %>
    </div>

    <div class="grid gap-4 lg:grid-cols-[minmax(0,2fr)_minmax(320px,1fr)]">
      <div class="rounded-xl border border-slate-200 bg-slate-50 p-4" data-timetable-editor-target="scroll">
        <div class="flex flex-col gap-4" data-timetable-editor-target="list">
          <% timetable.timetable_slots.each do |slot| %>
            <%= f.fields_for :timetable_slots, slot do |slot_fields| %>
              <%= render "events/timetable_slot_fields", f: slot_fields, artists: artists %>
            <% end %>
          <% end %>
        </div>
      </div>

      <aside class="space-y-4">
        <div class="space-y-4 rounded-xl border border-slate-200 bg-white p-4 text-sm shadow-sm">
          <h3 class="text-sm font-semibold text-slate-800">テンプレート</h3>
          <div class="grid gap-3">
            <div>
              <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">開始時刻</label>
              <% stage_start = timetable.timetable_slots.reject(&:marked_for_destruction?).map(&:start_time).compact.min %>
              <input type="time" value="<%= stage_start&.strftime('%H:%M') %>" data-timetable-editor-target="stageStart" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200" />
            </div>
            <div>
              <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">終了時刻</label>
              <% stage_end = timetable.timetable_slots.reject(&:marked_for_destruction?).map(&:end_time).compact.max %>
              <input type="time" value="<%= stage_end&.strftime('%H:%M') %>" data-timetable-editor-target="stageEnd" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200" />
            </div>
            <div class="grid gap-3 md:grid-cols-2">
              <div>
                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">出演枠 (分)</label>
                <input type="number" min="0" step="5" list="<%= dom_id(timetable, :performance_options) %>" placeholder="30" data-timetable-editor-target="performanceInput" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200" />
                <datalist id="<%= dom_id(timetable, :performance_options) %>">
                  <% TimetableSlot::PERFORMANCE_TEMPLATES.each do |minutes| %>
                    <option value="<%= minutes %>"></option>
                  <% end %>
                </datalist>
              </div>
              <div>
                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">転換枠 (分)</label>
                <input type="number" min="0" step="5" list="<%= dom_id(timetable, :changeover_options) %>" placeholder="10" data-timetable-editor-target="changeoverInput" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200" />
                <datalist id="<%= dom_id(timetable, :changeover_options) %>">
                  <% TimetableSlot::CHANGEOVER_TEMPLATES.each do |minutes| %>
                    <option value="<%= minutes %>"></option>
                  <% end %>
                </datalist>
              </div>
            </div>
          </div>
          <div class="grid gap-2">
            <button type="button" class="w-full rounded-lg bg-slate-900 px-3 py-2 text-sm font-semibold text-white shadow transition hover:bg-slate-700" data-action="timetable-editor#applyTemplates">設定した分数で順次割り当て</button>
            <button type="button" class="w-full rounded-lg border border-sky-500 px-3 py-2 text-sm font-semibold text-sky-600 transition hover:bg-sky-50" data-action="timetable-editor#distributeEvenly">開始・終了時刻で均等に配分</button>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50" data-action="timetable-editor#addPerformance">出演枠を追加</button>
          <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50" data-action="timetable-editor#addChangeover">転換枠を追加</button>
          <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50" data-action="timetable-editor#addOther">その他の枠を追加</button>
        </div>
      </aside>
    </div>

    <% new_slot = timetable.timetable_slots.build %>
    <% slot_template = f.fields_for :timetable_slots, new_slot, child_index: "NEW_RECORD" do |slot_fields| %>
      <%= render "events/timetable_slot_fields", f: slot_fields, artists: artists %>
    <% end %>
    <% timetable.timetable_slots.delete(new_slot) %>
    <template data-timetable-editor-target="template"><%= slot_template %></template>
  </div>
</div>
