<% can_manage_event = current_user&.organizer? && @event.organizer_id == current_user.id %>

<div class="flex flex-wrap items-center justify-between gap-4">
  <div>
    <div class="flex items-center gap-3 text-sm text-slate-500">
      <%= link_to "イベント一覧", events_path, class: "hover:text-sky-500" %>
      <span>/</span>
      <span>詳細</span>
    </div>
    <h1 class="mt-1 text-3xl font-semibold text-slate-900"><%= @event.name %></h1>
    <p class="mt-1 text-sm text-slate-500"><%= l @event.event_date %> @ <%= @event.venue %></p>
  </div>
  <% if can_manage_event %>
    <div class="flex flex-wrap items-center gap-3">
      <%= link_to "編集", edit_event_path(@event), class: "inline-flex items-center rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 transition hover:bg-slate-50" %>
      <%= link_to "タイムテーブルを編集", edit_timetable_event_path(@event), class: "inline-flex items-center rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-sky-500" %>
      <%= button_to "公開する", publish_event_path(@event), method: :post, class: "inline-flex items-center rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-emerald-500", form: { data: { turbo_confirm: "公開しますか？" } }, disabled: @event.published? %>
      <%= button_to "削除", @event, method: :delete,
            form: { data: { turbo_confirm: "イベントを削除しますか？この操作は取り消せません。" } },
            class: "inline-flex items-center rounded-lg bg-rose-600 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-rose-500" %>
    </div>
  <% end %>
</div>

<div class="mt-8 grid gap-6 lg:grid-cols-2">
  <section class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-800">イベント概要</h2>
    <dl class="mt-4 space-y-3">
      <div class="flex items-baseline justify-between text-sm">
        <dt class="text-slate-500">開催日</dt>
        <dd class="font-medium text-slate-800"><%= l @event.event_date %></dd>
      </div>
      <div class="flex items-baseline justify-between text-sm">
        <dt class="text-slate-500">会場</dt>
        <dd class="font-medium text-slate-800"><%= @event.venue %></dd>
      </div>
      <div class="flex items-baseline justify-between text-sm">
        <dt class="text-slate-500">開場</dt>
        <dd class="font-medium text-slate-800"><%= @event.door_time&.strftime("%H:%M") || "未設定" %></dd>
      </div>
      <div class="flex items-baseline justify-between text-sm">
        <dt class="text-slate-500">開演</dt>
        <dd class="font-medium text-slate-800"><%= @event.start_time&.strftime("%H:%M") || "未設定" %></dd>
      </div>
      <div class="border-t border-slate-100 pt-3 text-sm">
        <div class="flex justify-between">
          <span class="text-slate-500">イベント料</span>
          <span class="font-medium text-slate-800"><%= display_currency(@event.event_fee) %></span>
        </div>
        <div class="mt-1 flex justify-between">
          <span class="text-slate-500">ドリンク料</span>
          <span class="font-medium text-slate-800"><%= display_currency(@event.drink_fee) %></span>
        </div>
        <p class="mt-1 text-xs text-slate-500">※別途メニューあり</p>
        <div class="mt-3 flex items-center justify-between rounded-lg bg-slate-100 px-3 py-2 font-semibold text-slate-700">
          <span>合計</span>
          <span><%= display_currency(@event.entrance_fee) %></span>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <% badge_color = @event.published? ? "bg-emerald-100 text-emerald-700" : "bg-amber-100 text-amber-700" %>
        <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold <%= badge_color %>"><%= @event.state_i18n %></span>
      </div>
      <% if @event.description.present? %>
        <div class="rounded-lg bg-slate-50 px-3 py-3 text-sm text-slate-600">
          <%= simple_format(@event.description) %>
        </div>
      <% end %>
    </dl>
  </section>

  <section class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-slate-800">割引内容</h2>
        <p class="mt-1 text-sm text-slate-500">割引マスタで登録した内容から適用する割引を選択できます。</p>
      </div>
      <% if can_manage_event %>
        <%= link_to "割引を管理", discounts_path, class: "inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-xs font-semibold text-slate-600 transition hover:bg-slate-50" %>
      <% end %>
    </div>

    <div class="mt-4 space-y-5" data-controller="discount-selection">
      <div class="grid gap-4 md:grid-cols-[minmax(0,1.2fr)_minmax(0,1fr)]">
        <div>
          <label for="discount-preview" class="block text-xs font-semibold uppercase tracking-wide text-slate-500">割引を確認</label>
          <%= select_tag :discount_preview,
                options_from_collection_for_select(@available_discounts, :id, :name),
                include_blank: "割引を選択",
                data: { action: "change->discount-selection#selectChanged" },
                class: "mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200" %>
          <div class="mt-3 rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm">
            <div class="font-semibold text-slate-700" data-discount-selection-target="summaryName">割引を選択してください</div>
            <div class="mt-1 text-slate-600" data-discount-selection-target="summaryDetails"></div>
          </div>
        </div>
        <% breakdown = @discount_breakdown %>
        <% applied_discounts = breakdown.applied_discounts %>
        <div class="rounded-lg border border-slate-200 bg-white p-4 text-sm shadow-sm">
          <div class="flex justify-between text-slate-600">
            <span>通常料金</span>
            <span>¥<%= number_with_delimiter(breakdown.total_before) %></span>
          </div>
          <div class="mt-2 flex items-center justify-between rounded-lg bg-slate-900 px-3 py-2 font-semibold text-white shadow">
            <div>
              <span>割引後料金</span>
              <% if breakdown.savings.positive? %>
                <p class="text-[11px] font-normal text-slate-200">-¥<%= number_with_delimiter(breakdown.savings) %></p>
              <% end %>
            </div>
            <span>¥<%= number_with_delimiter(breakdown.total_after) %></span>
          </div>
          <div class="mt-4">
            <div class="flex items-center justify-between text-[11px] uppercase tracking-wide text-slate-400">
              <span>適用順序 (％ → 円)</span>
              <span>丸め: <%= breakdown.rounding_mode %></span>
            </div>
            <ol class="mt-2 space-y-2 text-sm">
              <% if applied_discounts.any? %>
                <% applied_discounts.each_with_index do |entry, index| %>
                  <li class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-2">
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-200 text-xs font-semibold text-slate-700"><%= index + 1 %></span>
                        <div>
                          <div class="font-semibold text-slate-800"><%= entry[:name] %></div>
                          <div class="text-[11px] text-slate-500">
                            <%= Discount.category_label_for(entry[:category]) %> /
                            <%= Discount.scope_label_for(entry[:scope]) %>
                          </div>
                        </div>
                      </div>
                      <% if entry[:savings].positive? %>
                        <span class="text-xs font-semibold text-emerald-600">-¥<%= number_with_delimiter(entry[:savings]) %></span>
                      <% else %>
                        <span class="text-xs text-slate-400">特典</span>
                      <% end %>
                    </div>
                    <% if entry[:line_breakdown].present? %>
                      <div class="mt-1 text-[11px] text-slate-500">
                        <% entry[:line_breakdown].each do |scope_key, amount| %>
                          <span class="mr-2"><%= Discount.scope_label_for(scope_key) %>: -¥<%= number_with_delimiter(amount) %></span>
                        <% end %>
                      </div>
                    <% end %>
                  </li>
                <% end %>
              <% else %>
                <li class="rounded-lg border border-dashed border-slate-300 bg-slate-50 px-3 py-2 text-xs text-slate-500">
                  適用されている割引はありません。
                </li>
              <% end %>
            </ol>
            <p class="mt-3 text-[11px] text-slate-400">①セット割 → ②学割 / スタッフ割（割引額優先）→ ③早割 → ④その他</p>
          </div>
        </div>
      </div>

      <% if can_manage_event %>
        <%= form_with scope: :discount_assignment, url: apply_discounts_event_path(@event), method: :patch, local: true, data: { turbo: false }, class: "space-y-4" do |form| %>
          <%= hidden_field_tag "discount_assignment[ids][]", "" %>
          <div class="grid gap-3">
            <% @available_discounts.each do |discount| %>
              <% effect_label =
                   if discount.kind_percentage?
                     "#{discount.value}% 割引"
                   elsif discount.kind_fixed?
                     "¥#{number_with_delimiter(discount.value)} 引き"
                   else
                     "特典"
                   end %>
              <% status = discount.status %>
              <% status_color =
                   case status
                   when :active then "bg-emerald-100 text-emerald-700"
                   when :upcoming then "bg-amber-100 text-amber-700"
                   when :expired then "bg-rose-100 text-rose-700"
                   else "bg-slate-200 text-slate-600"
                   end %>
              <% detail_text = [
                   "範囲: #{discount.scope_label}",
                   "併用: #{discount.stacking_label}",
                   discount.description.presence
                 ].compact.join(" / ") %>
              <label class="flex cursor-pointer items-start gap-3 rounded-lg border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm transition hover:border-sky-300"
                     data-discount-selection-target="row"
                     data-discount-id="<%= discount.id %>"
                     data-discount-name="<%= discount.name %>"
                     data-discount-details="<%= [effect_label, detail_text, "状態: #{discount.status_label}"].join(' / ') %>">
                <%= check_box_tag "discount_assignment[ids][]",
                      discount.id,
                      @event.discount_ids.include?(discount.id),
                      class: "mt-1 h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-200" %>
                <div class="flex flex-col gap-1">
                  <div class="text-sm font-semibold text-slate-800"><%= discount.name %></div>
                  <div class="flex flex-wrap items-center gap-2 text-[11px] text-slate-500">
                    <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 font-semibold text-slate-600"><%= discount.category_label %></span>
                    <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 font-semibold text-slate-600"><%= discount.scope_label %></span>
                    <span class="inline-flex items-center rounded-full px-2 py-0.5 font-semibold <%= status_color %>"><%= discount.status_label %></span>
                  </div>
                  <div class="text-xs text-slate-500">
                    <span class="font-semibold text-slate-700"><%= effect_label %></span>
                    <span class="ml-2"><%= detail_text %></span>
                  </div>
                </div>
              </label>
            <% end %>
            <% if @available_discounts.blank? %>
              <div class="rounded-lg border border-dashed border-slate-300 bg-slate-50 px-4 py-3 text-sm text-slate-500">
                割引が登録されていません。<%= link_to "割引を追加する", new_discount_path, class: "font-semibold text-sky-600 hover:text-sky-500" %>
              </div>
            <% end %>
          </div>
          <div class="flex justify-end">
            <%= form.submit "割引を適用", class: "inline-flex items-center rounded-lg bg-sky-600 px-5 py-2 text-sm font-semibold text-white shadow transition hover:bg-sky-500" %>
          </div>
        <% end %>
      <% else %>
        <div class="grid gap-3">
          <% @event.discounts.ordered.each do |discount| %>
            <% effect_label =
                 if discount.kind_percentage?
                   "#{discount.value}% 割引"
                 elsif discount.kind_fixed?
                   "¥#{number_with_delimiter(discount.value)} 引き"
                 else
                   "特典"
                 end %>
            <div class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-sm">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold text-slate-800"><%= discount.name %></div>
                  <div class="text-xs text-slate-500"><%= effect_label %></div>
                </div>
                <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-600"><%= discount.category_label %></span>
              </div>
              <div class="mt-1 text-xs text-slate-500">
                範囲: <%= discount.scope_label %> / 併用: <%= discount.stacking_label %>
              </div>
            </div>
          <% end %>
          <% if @event.discounts.blank? %>
            <div class="rounded-lg border border-dashed border-slate-300 bg-slate-50 px-4 py-3 text-sm text-slate-500">
              適用されている割引はありません。
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </section>
</div>

<section id="timetable" class="mt-6 rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
  <% timetables = @event_timetables || [] %>
  <% unassigned = timetables.any? { |t| t.timetable_slots.any? { |slot| !slot.changeover? && slot.artist.nil? } } %>
  <div class="flex flex-wrap items-center justify-between gap-3">
    <h2 class="text-lg font-semibold text-slate-800">タイムテーブル</h2>
    <div class="flex items-center gap-3">
      <% if unassigned %>
        <span class="rounded-lg bg-rose-100 px-3 py-1 text-xs font-semibold text-rose-700">出演アーティスト未定の枠があります</span>
      <% end %>
      <% if can_manage_event %>
        <%= link_to "タイムテーブルを編集", edit_timetable_event_path(@event), class: "text-sm font-semibold text-sky-600 hover:text-sky-500" %>
      <% end %>
    </div>
  </div>
  <% if timetables.present? %>
    <div class="mt-4 space-y-6">
      <% timetables.each do |timetable| %>
        <%= render "events/timetable_chart", timetable:, show_edit: can_manage_event %>
      <% end %>
    </div>
  <% else %>
    <div class="mt-4 rounded-lg border border-dashed border-slate-300 bg-slate-50 px-4 py-6 text-center text-sm text-slate-500">
      タイムテーブルが登録されていません。
    </div>
  <% end %>
</section>
